<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">
<head>
    <th:block th:include="fragments/head"></th:block>
    <title>Pet365 - Modifica Prodotto</title>

    <!-- CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@adminkit/core@latest/dist/css/app.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        .img-thumb, .preview-img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 12px;
            border: 1px solid #ddd;
            transition: transform .2s;
        }
        .img-thumb:hover { transform: scale(1.05); }
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 2000;
        }
    </style>
</head>

<body>
<div class="wrapper">
    <!-- Navbar Admin -->
    <th:block th:insert="~{fragments/navbarAdmin}"></th:block>

    <div class="main">
        <!-- Navbar Superiore -->
        <nav class="navbar navbar-expand navbar-light navbar-bg">
            <a class="sidebar-toggle js-sidebar-toggle">
                <i class="hamburger align-self-center"></i>
            </a>

            <div class="navbar-collapse collapse">
                <ul class="navbar-nav navbar-align">
                    <a><strong>BENVENUTO</strong>
                        <span th:text="${amministratore.nome} + ' ' + ${amministratore.cognome}"></span>
                    </a>
                </ul>
            </div>
        </nav>

        <!-- Contenuto Principale -->
        <div class="container-fluid mt-4">
            <div class="row d-flex justify-content-center">
                <div class="col-12 col-md-8 col-lg-6">
                    <div class="card shadow-lg border-0 rounded-3">
                        <div class="card-body">
                            <h2 class="text-center mb-4 text-success fw-bold">‚úèÔ∏è Modifica Prodotto</h2>

                            <form th:action="@{/admin/prodotti/aggiorna}"
                                  th:object="${form}"
                                  method="post"
                                  enctype="multipart/form-data">

                                <input type="hidden" th:field="*{id}"/>

                                <!-- Nome -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Nome prodotto</label>
                                    <input type="text" th:field="*{nome}" class="form-control" required>
                                </div>

                                <!-- Categoria -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Categoria</label>
                                    <input type="text" th:field="*{categoria}" class="form-control" required>
                                </div>

                                <!-- Descrizione -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Descrizione</label>
                                    <textarea th:field="*{descrizione}" class="form-control" rows="4" required></textarea>
                                </div>

                                <div class="row">
                                    <!-- Prezzo -->
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Prezzo (‚Ç¨)</label>
                                        <input type="number" step="0.01" th:field="*{prezzo}" class="form-control" required>
                                    </div>
                                    <!-- Quantit√† -->
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Quantit√† disponibile</label>
                                        <input type="number" min="0" th:field="*{quantitaDisponibile}" class="form-control" required>
                                    </div>
                                </div>

                                <!-- Foto esistenti -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Foto attuali</label>
                                    <div id="foto-container" class="d-flex flex-wrap gap-3">
                                        <div th:each="foto : ${prodotto.foto}" class="text-center" th:id="'foto-' + ${foto.id}">
                                            <img th:src="@{/imgProdotto(id=${foto.id})}" class="img-thumb" alt="Foto prodotto">
                                            <br>
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-danger mt-2 btn-elimina-foto"
                                                    th:data-idprodotto="${prodotto.id}"
                                                    th:data-idfoto="${foto.id}">
                                                üóëÔ∏è Elimina
                                            </button>
                                        </div>
                                    </div>
                                    <div th:if="${#lists.isEmpty(prodotto.foto)}" class="text-muted mt-2">
                                        Nessuna foto presente per questo prodotto.
                                    </div>
                                </div>

                                <!-- Nuove foto -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Aggiungi nuove foto</label>
                                    <input type="file" th:field="*{foto}" class="form-control" accept="image/*" multiple id="foto-input">
                                    <div class="form-text">Se selezioni nuove immagini, le vecchie verranno sostituite al salvataggio.</div>
                                    <div id="preview-container" class="d-flex flex-wrap gap-3 mt-3"></div>
                                    <div th:if="${erroreFile}" class="text-danger mt-2">Errore durante il caricamento delle immagini.</div>
                                </div>

                                <!-- Pulsante -->
                                <div class="d-grid mt-4">
                                    <button type="submit" class="btn btn-success btn-lg">
                                        üíæ Aggiorna Prodotto
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast container -->
        <div class="toast-container" id="toast-container"></div>
    </div>
</div>

<!-- JS -->
<script src="https://unpkg.com/@adminkit/core@latest/dist/js/app.js"></script>
<script src="https://unpkg.com/feather-icons"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>feather.replace();</script>

<script>
    // Preview immagini caricate
    document.getElementById('foto-input').addEventListener('change', function (event) {
        const container = document.getElementById('preview-container');
        container.innerHTML = '';
        const files = event.target.files;
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.classList.add('preview-img');
                container.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    });

    // Toast dinamico
    function mostraToast(messaggio, tipo = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
            <div class="toast align-items-center text-bg-${tipo} border-0 show mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">${messaggio}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>`;
        toastContainer.appendChild(wrapper);
        setTimeout(() => wrapper.remove(), 3000);
    }

    // Eliminazione foto AJAX
    document.querySelectorAll('.btn-elimina-foto').forEach(button => {
        button.addEventListener('click', async function () {
            const idProdotto = this.dataset.idprodotto;
            const idFoto = this.dataset.idfoto;
            try {
                const res = await fetch(`/admin/prodotti/${idProdotto}/foto/rimuovi/${idFoto}`, { method: 'DELETE' });
                if (res.ok) {
                    document.getElementById(`foto-${idFoto}`).remove();
                    mostraToast('Foto eliminata con successo');
                } else {
                    mostraToast('Errore durante la rimozione della foto', 'danger');
                }
            } catch (err) {
                mostraToast('Errore di connessione', 'danger');
            }
        });
    });
</script>
</body>
</html>
